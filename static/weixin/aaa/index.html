<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
  <script src="/weixin/aaa/vconsole.min.js"></script>
  <!-- <script src="./jweixin-1.2.0.js"></script> -->
</head>
<body>
    <button id="onMenuShareAppMessage" type="button">onMenuShareAppMessage! 分享给朋友</button>
    <button id="onMenuShareTimeline" type="button">onMenuShareTimeline! 分享到朋友圈</button>
    <button id="scanQRCode" type="button">scanQRCode! 微信扫一扫</button>
  <script>
var vConsole = new VConsole();
// var vConsole = new VConsole();
function SecureHashAlgorithm1(sIn) {
    var x = AlignSHA1(sIn);  
    var w = new Array(80);  
    var a = 1732584193;  
    var b = -271733879;  
    var c = -1732584194;  
    var d = 271733878;  
    var e = -1009589776;  

    for(var i = 0; i < x.length; i += 16) {  
        var olda = a;  
        var oldb = b;  
        var oldc = c;  
        var oldd = d;  
        var olde = e;  
        for(var j = 0; j < 80; j++) {  
            if(j < 16) w[j] = x[i + j];  
            else w[j] = rol(w[j - 3] ^ w[j - 8] ^ w[j - 14] ^ w[j - 16], 1);  
            t = add(add(rol(a, 5), ft(j, b, c, d)), add(add(e, w[j]), kt(j)));  
            e = d;  
            d = c;  
            c = rol(b, 30);  
            b = a;  
            a = t;  
        }  
        a = add(a, olda);  
        b = add(b, oldb);  
        c = add(c, oldc);  
        d = add(d, oldd);  
        e = add(e, olde);  
    }  

    SHA1Value = SHA1hex(a) + SHA1hex(b) + SHA1hex(c) + SHA1hex(d) + SHA1hex(e);  
    // return SHA1Value.toUpperCase();  
    return SHA1Value.toLowerCase();  

    // SHA1  
    function add(x, y) {  
        return((x & 0x7FFFFFFF) + (y & 0x7FFFFFFF)) ^ (x & 0x80000000) ^ (y & 0x80000000);  
    }  
    
    function SHA1hex(num) {  
        var sHEXChars = "0123456789abcdef";  
        var str = "";  
        for(var j = 7; j >= 0; j--)  
            str += sHEXChars.charAt((num >> (j * 4)) & 0x0F);  
        return str;  
    }  
    
    function AlignSHA1(sIn) {  
        var nblk = ((sIn.length + 8) >> 6) + 1,  
            blks = new Array(nblk * 16);  
        for(var i = 0; i < nblk * 16; i++) blks[i] = 0;  
        for(i = 0; i < sIn.length; i++)  
            blks[i >> 2] |= sIn.charCodeAt(i) << (24 - (i & 3) * 8);  
        blks[i >> 2] |= 0x80 << (24 - (i & 3) * 8);  
        blks[nblk * 16 - 1] = sIn.length * 8;  
        return blks;  
    }  
    
    function rol(num, cnt) {  
        return(num << cnt) | (num >>> (32 - cnt));  
    }  
    
    function ft(t, b, c, d) {  
        if(t < 20) return(b & c) | ((~b) & d);  
        if(t < 40) return b ^ c ^ d;  
        if(t < 60) return(b & c) | (b & d) | (c & d);  
        return b ^ c ^ d;  
    }  
    
    function kt(t) {  
        return(t < 20) ? 1518500249 : (t < 40) ? 1859775393 :  
            (t < 60) ? -1894007588 : -899497514;  
    }  
}

function CreateNonce(num) {
    num = num || 62;
    var chars = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'];
    
    return new Array(num).toString().split(',').map(() => (chars[Math.ceil(Math.random() * 61)])).join('');
}

var JsapiTicket = {
    'data': null,
    // {
    //     jsapi_ticket: "HoagFKDcsGMVCIY2vOjf9i4WM89Ae-huRok--absG9gtNAxdI2ZBeGNMCtzU0_iRsd5JhXEWgZBc1Q0lC3SOvQ"
    //     expires_timestamp: 1512462776000
    // },
    fetch: function () {
        var _this = this;
        
        return new Promise(function (resolve, reject) {
            // fetch('http://localhost:3000/weixin/getJsapiTicket', {
            fetch('https://rejiejay.cn/server/weixin/getJsapiTicket', {
            // fetch('http://dvt.free.ngrok.cc/Dvt-web/api/signature.do', {
                method: 'GET'
            }).then(function (response) {
                return response.json()
            }).then(function (val) {
                // console.log(val)
                // if (val.result === '0') {
                //     _this.jsapi_ticket = val.data;
                //     _this.save(val.data);
                //     resolve(val.data.jsapi_ticket);
                // } else {
                //     reject(val.message);
                // }

                if (val.result === 1) {
                    _this.jsapi_ticket = val.data;
                    _this.save(val.data);
                    resolve(val.data.jsapi_ticket);
                } else {
                    reject(val.message);
                }
            }, function (error) {
                reject(error);
            }).catch(function(error) {
                reject(error);
            });
        });
    },
    get: function() {
        var _this = this;
        
        return new Promise(function (resolve, reject) {
            var mydata = JSON.parse(localStorage.getItem("jsapi_ticket"));

            if (mydata == null) {
                _this.fetch()
                .then(function(val) {
                    resolve(val);
                }, function(error) {
                    reject(error);
                });
            } else {
                let nowTimestamp = Date.parse(new Date());

                if (mydata.expires_timestamp > nowTimestamp) {
                    resolve(mydata.jsapi_ticket);
                } else {
                    _this.fetch()
                    .then(function(val) {
                        resolve(val);
                    }, function(error) {
                        reject(error);
                    });
                }
            }
        });
    },
    save: function(data) {
        var jsapi_ticket = data || this.data;
        localStorage.setItem("jsapi_ticket", JSON.stringify(jsapi_ticket));
    }
}

// JsapiTicket.get()
// .then(function(val) {
//     var jsapi_ticket = val,
//         nonceStr = CreateNonce(16),
//         timestamp = Date.parse(new Date()) / 1000,
//         url = window.location.href.replace(window.location.hash, '');

//     var SecureHashAlgorithmString = 'jsapi_ticket=' + jsapi_ticket + '&noncestr=' + nonceStr + '&timestamp=' + timestamp + '&url=' + url;
    
//     var signature = SecureHashAlgorithm1(SecureHashAlgorithmString);

//     wx.config({
//         debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
//         appId: 'wx34ce4f0ce6eadb39', // 必填，公众号的唯一标识
//         timestamp: timestamp, // 必填，生成签名的时间戳
//         nonceStr: nonceStr, // 必填，生成签名的随机串
//         signature: signature,// 必填，签名，见附录1
//         jsApiList: [
//             'onMenuShareTimeline',
//             'onMenuShareAppMessage',
//             'scanQRCode'
//         ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
//     });
//     wx.checkJsApi({
//         jsApiList: [
//             'onMenuShareTimeline',
//             'onMenuShareAppMessage',
//             'scanQRCode'
//         ], // 需要检测的JS接口列表，所有JS接口列表见附录2,
//         success: function(res) {
//             console.log('检测的JS接口')
//             console.log(res)
//             // 以键值对的形式返回，可用的api值true，不可用为false
//             // 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
//         }
//     });
// }, function(error) {
//     alert(error);
// });


wx.ready(function(){
    document.getElementById('onMenuShareAppMessage').onclick = function() {
        wx.onMenuShareAppMessage({
            title: '这是标题', // 分享标题
            desc: '这是描述', // 分享描述
            link: 'https://rejiejay.cn/weixin/', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            imgUrl: 'https://rejiejay.cn/weixin/saber.jpg', // 分享图标
            type: 'link', // 分享类型,music、video或link，不填默认为link
            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
            complete: function () {
                console.log('已执行onMenuShareAppMessage')
            },
            success: function () {
                console.log('你已经确认分享')
                // 用户确认分享后执行的回调函数
            },
            cancel: function () { 
                console.log('你已经取消分享')
                // 用户取消分享后执行的回调函数
            }
        });
    }
    document.getElementById('onMenuShareTimeline').onclick = function() {
        wx.onMenuShareTimeline({
            title: '这是标题', // 分享标题
            link: 'https://rejiejay.cn/weixin/', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            imgUrl: 'https://rejiejay.cn/weixin/saber.jpg', // 分享图标
            complete: function () {
                console.log('onMenuShareTimeline')
            },
            success: function () {
                console.log('你已经确认分享')
                // 用户确认分享后执行的回调函数
            },
            cancel: function () { 
                console.log('你已经取消分享')
                // 用户取消分享后执行的回调函数
            }
        });
    }

    document.getElementById('scanQRCode').onclick = function() {
        wx.scanQRCode({
            needResult: 0, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
            scanType: 'qrCode', // 可以指定扫二维码还是一维码，默认二者都有
            success: function (res) {
                var result = res.resultStr; // 当 needResult 为 1 时，扫码返回的结果
            }
        });
    }
    // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
});

fetch('http://dvt.free.ngrok.cc/Dvt-web/api/signature.do', {
    method: 'GET'
}).then(function (response) {
    return response.json()
}).then(function(val) {
    console.log(val);
    // wx.config({
    //     debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
    //     appId: 'wx34ce4f0ce6eadb39', // 必填，公众号的唯一标识
    //     timestamp: timestamp, // 必填，生成签名的时间戳
    //     nonceStr: nonceStr, // 必填，生成签名的随机串
    //     signature: signature,// 必填，签名，见附录1
    //     jsApiList: [
    //         'onMenuShareTimeline',
    //         'onMenuShareAppMessage',
    //         'scanQRCode'
    //     ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    // });
})

wx.error(function(res){
    console.log('微信wx.config信息验证失败, 原因:');
    console.log(res);
    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
});
  </script>
</body>
</html>